pipeline {
    agent any
    environment {
        HTTP_PROXY = 'http://127.0.0.1:7897'
        HTTPS_PROXY = 'http://127.0.0.1:7897'
        NO_PROXY = 'localhost,127.0.0.1'
    }
    stages {
        stage('Setup Node.js Environment') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'dc', passwordVariable: 'password', usernameVariable: 'username')]) {
                        bat "docker login -u $username -p $password ..."
                    }

                    // Pull the Blog Docker image
                    bat 'docker pull node:22'

                    // Init
                    bat '''
                         rm -rf hanakoi-blog
                         docker stop node_container
                         docker rm node_container
                    '''

                    // Run Docker container and execute commands inside it
                    bat '''
                        docker run -d --name node_container -p 3000:3000 -e HTTP_PROXY=${HTTP_PROXY} -e HTTPS_PROXY=${HTTPS_PROXY} -e NO_PROXY=${NO_PROXY} node:22 /bin/bash -c "
                            npm install forever -g && \
                            git clone https://github.com/HarrySunV9x/hanakoi-blog && \
                            cd hanakoi-blog && \
                            npm install && \
                            npm run build && \
                            forever start -c "npm run start" .
                        "
                    '''
                }
            }
        }
    }
}
